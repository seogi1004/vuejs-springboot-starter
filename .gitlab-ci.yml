# 사용자 프로파일 설정에서 PERSONAL_ACCESS_TOKEN을 발급해야함
variables:
  MAVEN_CLI_OPTS: "--batch-mode clean verify"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  CI_REPOSITORY_URL: https://alvin.h:$ACCESS_TOKEN@gitlab.com/$CI_PROJECT_PATH.git

# untracked 옵션이 true면, Git에 추가되지 않은 모든 파일들을 캐싱함
cache:
  key: "$CI_BUILD_REF_NAME"
  paths:
    - src/main/resources/static/
    - dist/
    
stages:
  - fetest
  - betest
  - febuild
  - bebuild
  - deploy
  - patch
    
.Job_Only:
  only:
    changes:
      - "src/**/*"
      - "package-lock.json"
      - "webpack.config.json"
      - "pom.xml"
    refs:
      - master
    
FE_Test:
  extends: .Job_Only
  image: node:10
  stage: fetest
  before_script:
    - npm install
  script:
    - npm test
  coverage: /All files\s*\|\s*([\d\.]+)/

BE_Test:
  extends: .Job_Only
  image: maven:3.3.9
  stage: betest
  script:
    - mvn test $MAVEN_OPTS $MAVEN_CLI_OPTS

FE_Build:
  extends: .Job_Only
  image: node:10
  stage: febuild
  before_script:
    - npm install
  script:
    - npm run dist
    - ls -all ./src/main/resources/static

BE_Build:
  extends: .Job_Only
  image: maven:3.3.9
  stage: bebuild
  script:
    - mvn install -DskipTests=true $MAVEN_OPTS $MAVEN_CLI_OPTS

Deploy:
  extends: .Job_Only
  stage: deploy
  before_script:
    - apt-get update -qq && apt-get install -y -qq sshpass
  script:
    - ls -all ./dist
    - sshpass -V
    - export SSHPASS=$SSH_PASSWORD
    - sshpass -e scp -P51022 -oStrictHostKeyChecking=no -r ./dist/vuejs-springboot-starter-$TAG_VERSION.jar root@61.37.50.64:/opt/public

Patch:
  only:
    variables:
      - $TAG_VERSION =~ /-release$/i
    refs:
      - master
  stage: patch
  before_script:
    - git config --global user.name "alvin.h"
    - git config --global user.email "seogi777@gmail.com"
  script:
    - git checkout $CI_COMMIT_REF_NAME
    - git remote remove origin
    - git remote add origin $CI_REPOSITORY_URL
    - git tag -a $TAG_VERSION -m "Version created by gitlab-ci Build"
    - git push origin --tags