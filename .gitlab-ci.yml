# 사용자 프로파일 설정에서 PERSONAL_ACCESS_TOKEN을 발급해야함
variables:
  MAVEN_CLI_OPTS: "--batch-mode"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  CI_REPOSITORY_URL: https://alvin.h:$ACCESS_TOKEN@gitlab.com/$CI_PROJECT_PATH.git

# untracked 옵션이 true면, Git에 추가되지 않은 모든 파일들을 캐싱함
cache:
  key: "$CI_BUILD_REF_NAME"
  paths:
    - src/main/resources/static/
    - dist/
    - node_modules/
    - .m2/repository/
    
stages:
#  - fetest
#  - febuild
#  - betest
#  - bebuild
  - bereport
#  - deploy
#  - patch
    
.Job_Only:
  only:
    changes:
      - "src/**/*"
    refs:
      - merge_requests
   
#FE_Test:
#  extends: .Job_Only
#  image: node:10
#  stage: fetest
#  before_script:
#    - npm install
#  script:
#    - npm test
#  coverage: /All files\s*\|\s*([\d\.]+)/
#
#FE_Build:
#  extends: .Job_Only
#  image: node:10
#  stage: febuild
#  before_script:
#    - npm install
#  script:
#    - npm run dist
#    - ls -all ./src/main/resources/static
#
#BE_Test:
#  extends: .Job_Only
#  image: maven:3.3.9
#  stage: betest
#  script:
#    - mvn test $MAVEN_OPTS
#
#BE_Build:
#  extends: .Job_Only
#  image: maven:3.3.9
#  stage: bebuild
#  script:
#    - mvn install -DskipTests=true $MAVEN_OPTS $MAVEN_CLI_OPTS

BE_Report:
  extends: .Job_Only
  image: maven:3.3.9
  stage: bereport
  before_script:
    - mvn clean package jacoco:report
  script:
    - mvn sonar:sonar \
      -Dsonar.projectKey=vuejs-springboot-starter \
      -Dsonar.organization=alvin \
      -Dsonar.host.url=https://sonarcloud.io \
      -Dsonar.login=f383e836d32c4e9652edcaec0652fc255d253746

#Deploy:
#  extends: .Job_Only
#  image: maven:3.3.9
#  stage: deploy
#  before_script:
#    - POM_VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive exec:exec)
#    - apt-get update -qq && apt-get install -y -qq sshpass
#  script:
#    - ls -all ./dist
#    - sshpass -V
#    - export SSHPASS=$SSH_PASSWORD
#    # SSH_COMMAND 변수 값은 USERNAME@IP:UPLOAD_PATH, 포트가 다르면 -P 옵션을 줄것
#    - sshpass -e scp -r -oStrictHostKeyChecking=no ./dist/vuejs-springboot-starter-$POM_VERSION.jar $SSH_COMMAND
#
#Patch:
#  image: maven:3.3.9
#  only:
#    changes:
#      - "pom.xml"
#    refs:
#      - merge_requests
#  stage: patch
#  before_script:
#    - POM_VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive exec:exec)
#    - echo $POM_VERSION
#    - git config --global user.name "alvin.h"
#    - git config --global user.email "seogi777@gmail.com"
#  script:
#    - git checkout $CI_COMMIT_REF_NAME
#    - git remote remove origin
#    - git remote add origin $CI_REPOSITORY_URL
#    - git tag -a $POM_VERSION -m "Version created by gitlab-ci Build"
#    - git push origin --tags