variables:
  MAVEN_CLI_OPTS: "--batch-mode"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

# And to cache them as well.
cache:
  key: "$CI_BUILD_REF_NAME"
  untracked: true
  paths:
    - dist/
    - src/main/resources/static/

# You specify the stages. Those are the steps that GitLab will go through 
# Order matters. 
stages:
#   - fetest
#   - betest
#   - febuild
#   - bebuild
#   - deploy
  - patch

.Job_Only:
  only:
    changes:
      - "src/**/*"
      - "package-lock.json"
      - "webpack.config.json"
      - "pom.xml"
    refs:
      - master

# FE_Test:
#   extends: .Job_Only
#   image: node:10
#   stage: fetest
#   before_script:
#     - npm install
#   script:
#     - npm test
#   coverage: /All files\s*\|\s*([\d\.]+)/

# BE_Test:
#   extends: .Job_Only
#   image: maven:3.3.9
#   stage: betest
#   script:
#     - mvn test $MAVEN_CLI_OPTS clean verify

# FE_Build:
#   extends: .Job_Only
#   image: node:10
#   stage: febuild
#   before_script:
#     - npm install
#   script:
#     - npm run dist
#     - ls -all ./src/main/resources/static

# BE_Build:
#   extends: .Job_Only
#   image: maven:3.3.9
#   stage: bebuild
#   script:
#     - mvn -DskipTests=true install $MAVEN_CLI_OPTS clean verify

# Deploy:
#   extends: .Job_Only
#   stage: deploy
#   before_script:
#     - apt-get update -qq && apt-get install -y -qq sshpass
#   script:
#     - ls -all ./dist
#     - sshpass -V
#     - export SSHPASS=$SSH_PASSWORD
#     - sshpass -e scp -P51022 -oStrictHostKeyChecking=no -r ./dist/vuejs-springboot-starter-$TAG_VERSION.jar root@61.37.50.64:/opt/public

Patch:
  extends: .Job_Only
  stage: patch
  script:
    - export CI_PUSH_REPO=`echo $CI_BUILD_REPO | perl -pe 's#.*@(.+?(\:\d+)?)/#git@\1:#' | perl -pe 's/:gitlab\//:\//'`
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git config --global user.email "${GITLAB_USER_EMAIL}"
    - git checkout $CI_BUILD_REF_NAME
    - git remote set-url --push origin "$CI_PUSH_REPO"
    - git tag -a $TAG_VERSION -m "Version created by gitlab-ci Build"
    - git push --tags