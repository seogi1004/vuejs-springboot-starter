stages:
  - fetest
  - betest
  - febuild
  - bebuild
  - deploy
  - patch

.Job_Only:
  only:
    changes:
      - "src/**/*"
      - "package-lock.json"
      - "webpack.config.json"
      - "pom.xml"
    refs:
      - master
    
FE_Test:
  extends: .Job_Only
  image: node:10
  stage: fetest
  cache:
    key: "$CI_BUILD_REF_NAME"
      untracked: true
      paths:
        - node_modules/
  before_script:
    - npm install
  script:
    - npm test
  coverage: /All files\s*\|\s*([\d\.]+)/

BE_Test:
  extends: .Job_Only
  image: maven:3.3.9
  stage: betest
  cache:
    key: "$CI_BUILD_REF_NAME"
      untracked: true
      paths:
        - .m2/repository/
        - target/
  script:
    - mvn test $MAVEN_CLI_OPTS clean verify

FE_Build:
  extends: .Job_Only
  image: node:10
  stage: febuild
  cache:
    key: "$CI_BUILD_REF_NAME"
    untracked: true
    paths:
      - src/main/resources/static/
  before_script:
    - npm install
  script:
    - npm run dist
    - ls -all ./src/main/resources/static

BE_Build:
  extends: .Job_Only
  image: maven:3.3.9
  stage: bebuild
  cache:
    key: "$CI_BUILD_REF_NAME"
    untracked: true
    paths:
      - dist/
  variables:
    MAVEN_CLI_OPTS: "--batch-mode"
    MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  script:
    - mvn -DskipTests=true install $MAVEN_CLI_OPTS clean verify

Deploy:
  extends: .Job_Only
  stage: deploy
  before_script:
    - apt-get update -qq && apt-get install -y -qq sshpass
  script:
    - ls -all ./dist
    - sshpass -V
    - export SSHPASS=$SSH_PASSWORD
    - sshpass -e scp -P51022 -oStrictHostKeyChecking=no -r ./dist/vuejs-springboot-starter-$TAG_VERSION.jar root@61.37.50.64:/opt/public

Patch:
  extends: .Job_Only
  stage: patch
  variables:
    CI_REPOSITORY_URL: https://alvin.h:$ACCESS_TOKEN@gitlab.com/$CI_PROJECT_PATH.git 
  before_script:
  - git config --global user.name "alvin.h"
  - git config --global user.email "seogi777@gmail.com"
  script:
    - git checkout $CI_COMMIT_REF_NAME
    - git remote remove origin
    - git remote add origin $CI_REPOSITORY_URL
    - git tag -a $TAG_VERSION -m "Version created by gitlab-ci Build"
    - git push origin --tags